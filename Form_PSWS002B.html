<script src="https://ipcenter-dev.pwcinternal.com/jquery/jquery.min.js"></script>

<script>
// personalize behaviour here
  var token = 123;
  var domain = "intusers";
  var minLetters = "4";
  var doneTypingInterval = 1000;  //time in ms, 1 second for example
// end personalization

  var xhttp = new XMLHttpRequest();
  var userL = [];
  var typingTimer;
  var prev = "###";

  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
	   var txt = xhttp.responseText.split("|");
	   var list = $("#userList");
	   list.empty();
	   for (var i = 0; i < txt.length; i++) {
	     var qq = txt[i].search("please type additional characters");
	     if (txt[i].search("please type additional characters") > 0) {
		   prev = "###";
		 }  
	     item = "<option value=" + '"' + txt[i].trim() + '">';
		 list.append(item);
	   }
       $("#searching").html("&nbsp;");
    }
  };

function ADSearch(text) {
  var uri = "http://10.240.248.242:8080/?token=" + token + "&action=search&domain=" + domain + "&search=" + text
  xhttp.open("GET", uri, true);
  xhttp.send();
  console.log("AD Request Sent");
}

function doSearch(text) {
    console.log("doSearch " + text);
	if (text.length >= minLetters) {
	  var pos = text.search(prev)
	  if (pos < 0) {
	    console.log("AD search: " + text);
        $("#searching").html("searching...");
	    ADSearch(text);
	    prev = text;
	  } else {
	    console.log("new search is a substring of previous");
      }	
	} else {
	  console.log("less than " + minLetters + " keys pressed");
	}
}

$(document).ready(function(){
 $("#userInput").keyup(function() {
  clearTimeout(typingTimer);
  var text = this.value;
  typingTimer = setTimeout(function() { doSearch(text) }, doneTypingInterval);
  });
});

$(document).ready(function(){
 $("#userInput").keydown(function() {
  //on keydown, clear the countdown
  clearTimeout(typingTimer);
  });
});

function doAdd() {
	var elem = $("#userInput");
	var value = elem.val();
	userL.push(value);
	var str = "<div><b>Selected Users</b></div>";
	var arr = "";
	for(var i = 0; i < userL.length; i++) {
	  str += userL[i] + "<br>"
	  arr += userL[i] + "|"
	}
	$("#members").html(str);
	$("#userList").empty();
	elem.val("");
	arr = arr.replace(/\|$/g,"");
	$("#input").val(arr)
}

</script>

<tr>
  <td class="list-padding radar_right radar_text">out:</td>
  <td class="list-padding radar_left radar_text">
    <span class="radar_error">$!{errors.out}</span>
   <input id="input" type="hidden"  name="variables['out']">
  </td>
</tr>
<tr>
  <td>

<div id="page-wrap">

<h3>Please Select User</h3>
<div>
Type minimum <script>document.write(minLetters)</script> letters to start searching (after <script>document.write(Math.round(doneTypingInterval/100)/10);</script> seconds of inactivity)
<div>
<div id="searching">&nbsp;</div>
<input id ="userInput" size="30" list="userList" name="userList">
<datalist id="userList">
</datalist>
</input>
<button type="button" id="add" onclick='doAdd()'>Add</button>
<br>
<span></span>
<br><br>
<span id="members"></span>
<br>
</div>
